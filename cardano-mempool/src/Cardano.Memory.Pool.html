<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MagicHash #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE UnboxedTuples #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- | The goal of this Memory Pool is to provide the ability to allocate big chunks of</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- memory that can fit many `Block`s. Some memory allocators out there have a fairly large</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- minimal size requirement, which would be wasteful if many chunks of small size (eg. 32</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- bytes) are needed at once. Memory pool will allocate one page at a time as more blocks</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- is needed.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- Currently there is no functionality for releasing unused pages. So, once a page is</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- allocated, it will be re-used when more `Block`s is needed, but it will not be GCed</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- until the whole `Pool` is GCed.</span><span>
</span><span id="line-21"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Memory.Pool</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Pool</span></span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier">Pool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#initPool"><span class="hs-identifier">initPool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Block</span></span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#blockByteCount"><span class="hs-identifier">blockByteCount</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextBlock"><span class="hs-identifier">grabNextBlock</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Helpers</span></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-comment">-- Exported for testing</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#countPages"><span class="hs-identifier">countPages</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#findNextZeroIndex"><span class="hs-identifier">findNextZeroIndex</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Applicative</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Data.Bits</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier">Data.Primitive.MutVar</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier">Data.Primitive.PVar</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier">Data.Primitive.PVar.Unsafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier">atomicModifyIntArray#</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier">Data.Primitive.PrimArray</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Foreign.ForeignPtr</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Foreign.Ptr</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.Exts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier">fetchAndIntArray#</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">addForeignPtrConcFinalizer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.IO</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.Int</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.ST</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.TypeLits</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | This is just a proxy type that carries information at the type level about the size</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- of the block in bytes supported by a particular instance of a `Pool`. Use</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- `blockByteCount` to get the byte size at the value level.</span><span>
</span><span id="line-58"></span><span class="hs-keyword">data</span><span> </span><span id="Block"><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-var">Block</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679043159"><span class="annot"><a href="#local-6989586621679043159"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Nat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Block"><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-var">Block</span></a></span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- | Number of bytes in a `Block`</span><span>
</span><span id="line-61"></span><span id="local-6989586621679043234"><span class="annot"><a href="Cardano.Memory.Pool.html#blockByteCount"><span class="hs-identifier hs-type">blockByteCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043234"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043234"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span></span><span>
</span><span id="line-62"></span><span id="blockByteCount"><span class="annot"><span class="annottext">blockByteCount :: forall (n :: Nat). KnownNat n =&gt; Block n -&gt; Int
</span><a href="Cardano.Memory.Pool.html#blockByteCount"><span class="hs-identifier hs-var hs-var">blockByteCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; Integer -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromInteger</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (n :: Nat) (proxy :: Nat -&gt; *).
KnownNat n =&gt;
proxy n -&gt; Integer
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">natVal</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- | Internal helper type that manages each individual page. This is essentailly a mutable</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- linked list, which contains a memory buffer, a bit array that tracks which blocks in</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- the buffere are free and which ones are taken.</span><span>
</span><span id="line-67"></span><span class="hs-keyword">data</span><span> </span><span id="Page"><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-var">Page</span></a></span></span><span> </span><span id="local-6989586621679043225"><span class="annot"><a href="#local-6989586621679043225"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679043224"><span class="annot"><a href="#local-6989586621679043224"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Page"><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-var">Page</span></a></span></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="pageMemory"><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; ForeignPtr (Block n)
</span><a href="Cardano.Memory.Pool.html#pageMemory"><span class="hs-identifier hs-var hs-var">pageMemory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043225"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-comment">-- ^ Contiguous memory buffer that holds all the blocks in the page.</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="pageBitArray"><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; MutablePrimArray s Int
</span><a href="Cardano.Memory.Pool.html#pageBitArray"><span class="hs-identifier hs-var hs-var">pageBitArray</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043224"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-comment">-- ^ We use an Int array, because there are no built-in atomic primops for Word.</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="pageFull"><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; PVar Int s
</span><a href="Cardano.Memory.Pool.html#pageFull"><span class="hs-identifier hs-var hs-var">pageFull</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier hs-type">PVar</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043224"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-comment">-- ^ This is a boolean flag which indicates when a page is full. It here as</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-comment">-- optimization only, because it allows us to skip iteration of the above bit</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-comment">-- array. It is an `Int` instead of a `Bool`, because GHC provides atomic primops for</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-comment">-- ByteArray, whcih is what `PVar` is based on.</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="pageNextPage"><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; MutVar s (Maybe (Page n s))
</span><a href="Cardano.Memory.Pool.html#pageNextPage"><span class="hs-identifier hs-var hs-var">pageNextPage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutVar</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043224"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043225"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043224"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-comment">-- ^ Link to the next page. Last page when this IORef contains `Nothing`</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- | Thread-safe lock-free memory pool for managing large memory pages that contain of</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- many small `Block`s.</span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="Pool"><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-var">Pool</span></a></span></span><span> </span><span id="local-6989586621679043210"><span class="annot"><a href="#local-6989586621679043210"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679043209"><span class="annot"><a href="#local-6989586621679043209"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Pool"><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-var">Pool</span></a></span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="poolFirstPage"><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; Page n s
</span><a href="Cardano.Memory.Pool.html#poolFirstPage"><span class="hs-identifier hs-var hs-var">poolFirstPage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043210"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043209"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-comment">-- ^ Initial page, which itself contains references to subsequent pages</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="poolPageInitializer"><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; ST s (Page n s)
</span><a href="Cardano.Memory.Pool.html#poolPageInitializer"><span class="hs-identifier hs-var hs-var">poolPageInitializer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043209"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043210"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043209"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-comment">-- ^ Page initializing action</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="poolBlockFinalizer"><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; Ptr (Block n) -&gt; IO ()
</span><a href="Cardano.Memory.Pool.html#poolBlockFinalizer"><span class="hs-identifier hs-var hs-var">poolBlockFinalizer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043210"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-comment">-- ^ Finilizer that will be attached to each individual `ForeignPtr` of a reserved</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-comment">-- `Block`.</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | Useful function for testing. Check how many pages have been allocated thus far.</span><span>
</span><span id="line-94"></span><span id="local-6989586621679043199"><span id="local-6989586621679043200"><span class="annot"><a href="Cardano.Memory.Pool.html#countPages"><span class="hs-identifier hs-type">countPages</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-type">Pool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043200"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043199"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043199"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span></span></span><span>
</span><span id="line-95"></span><span id="countPages"><span class="annot"><span class="annottext">countPages :: forall (n :: Nat) s. Pool n s -&gt; ST s Int
</span><a href="Cardano.Memory.Pool.html#countPages"><span class="hs-identifier hs-var hs-var">countPages</span></a></span></span><span> </span><span id="local-6989586621679043042"><span class="annot"><span class="annottext">Pool n s
</span><a href="#local-6989586621679043042"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {t} {n :: Nat}.
(PrimMonad m, Num t) =&gt;
t -&gt; Page n (PrimState m) -&gt; m t
</span><a href="#local-6989586621679043041"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; Page n s
</span><a href="Cardano.Memory.Pool.html#poolFirstPage"><span class="hs-identifier hs-var">poolFirstPage</span></a></span><span> </span><span class="annot"><span class="annottext">Pool n s
</span><a href="#local-6989586621679043042"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-97"></span><span>    </span><span id="local-6989586621679043041"><span class="annot"><span class="annottext">go :: t -&gt; Page n (PrimState m) -&gt; m t
</span><a href="#local-6989586621679043041"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679043029"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679043029"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043028"><span class="annot"><span class="annottext">MutVar (PrimState m) (Maybe (Page n (PrimState m)))
pageNextPage :: MutVar (PrimState m) (Maybe (Page n (PrimState m)))
pageNextPage :: forall (n :: Nat) s. Page n s -&gt; MutVar s (Maybe (Page n s))
</span><a href="#local-6989586621679043028"><span class="hs-identifier hs-var hs-var">pageNextPage</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MutVar (PrimState m) a -&gt; m a
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">readMutVar</span></a></span><span> </span><span class="annot"><span class="annottext">MutVar (PrimState m) (Maybe (Page n (PrimState m)))
</span><a href="#local-6989586621679043028"><span class="hs-identifier hs-var">pageNextPage</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Page n (PrimState m))
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679043029"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679043026"><span class="annot"><span class="annottext">Page n (PrimState m)
</span><a href="#local-6989586621679043026"><span class="hs-identifier hs-var">nextPage</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; Page n (PrimState m) -&gt; m t
</span><a href="#local-6989586621679043041"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679043029"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Page n (PrimState m)
</span><a href="#local-6989586621679043026"><span class="hs-identifier hs-var">nextPage</span></a></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="annot"><a href="Cardano.Memory.Pool.html#ixBitSize"><span class="hs-identifier hs-type">ixBitSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-103"></span><span id="ixBitSize"><span class="annot"><span class="annottext">ixBitSize :: Int
</span><a href="Cardano.Memory.Pool.html#ixBitSize"><span class="hs-identifier hs-var hs-var">ixBitSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. FiniteBits b =&gt; b -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">finiteBitSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- | Initilizes the `Pool` that can be used for further allocation of @`ForeignPtr`</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- `Block` n@ with `grabNextBlock`.</span><span>
</span><span id="line-107"></span><span class="annot"><a href="Cardano.Memory.Pool.html#initPool"><span class="hs-identifier hs-type">initPool</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043181"><span class="annot"><a href="#local-6989586621679043181"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679043180"><span class="annot"><a href="#local-6989586621679043180"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043181"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-comment">-- | Number of groups per page. Must be a posititve number, otherwise error. One group</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-comment">-- contains as many blocks as the operating system has bits. A 64bit architecture will</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-comment">-- have 64 blocks per group. For example, if program is compiled on a 64 bit OS and you</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-comment">-- know ahead of time the maximum number of blocks that will be allocated through out</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-comment">-- the program, then the optimal value for this argument will @maxBlockNum/64@</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-comment">-- | Mempool page allocator. Some allocated pages might be immediately discarded,</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-comment">-- therefore number of pages utilized will not necessesarely match the number of times</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-comment">-- this action will be called.</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043179"><span class="annot"><a href="#local-6989586621679043179"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043180"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043179"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-comment">-- | Finalizer to use for each block. It is an IO action because it will be executed by</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-comment">-- the Garbage Collector in a separate thread once the `Block` is no longer referenced.</span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043181"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043180"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-type">Pool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043181"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043180"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span id="initPool"><span class="annot"><span class="annottext">initPool :: forall (n :: Nat) s.
KnownNat n =&gt;
Int
-&gt; (forall a. Int -&gt; ST s (ForeignPtr a))
-&gt; (Ptr (Block n) -&gt; IO ())
-&gt; ST s (Pool n s)
</span><a href="Cardano.Memory.Pool.html#initPool"><span class="hs-identifier hs-var hs-var">initPool</span></a></span></span><span> </span><span id="local-6989586621679043008"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679043008"><span class="hs-identifier hs-var">groupsPerPage</span></a></span></span><span> </span><span id="local-6989586621679043007"><span class="annot"><span class="annottext">forall a. Int -&gt; ST s (ForeignPtr a)
</span><a href="#local-6989586621679043007"><span class="hs-identifier hs-var">memAlloc</span></a></span></span><span> </span><span id="local-6989586621679043006"><span class="annot"><span class="annottext">Ptr (Block n) -&gt; IO ()
</span><a href="#local-6989586621679043006"><span class="hs-identifier hs-var">blockFinalizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679043008"><span class="hs-identifier hs-var">groupsPerPage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Groups per page should be a positive number, but got: &quot;</span></span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679043008"><span class="hs-identifier hs-var">groupsPerPage</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679042979"><span class="annot"><span class="annottext">pageInit :: ST s (Page n s)
</span><a href="#local-6989586621679042979"><span class="hs-identifier hs-var hs-var">pageInit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>        </span><span id="local-6989586621679042978"><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042978"><span class="hs-identifier hs-var">pageMemory</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-131"></span><span>          </span><span class="annot"><span class="annottext">forall a. Int -&gt; ST s (ForeignPtr a)
</span><a href="#local-6989586621679043007"><span class="hs-identifier hs-var">memAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679043008"><span class="hs-identifier hs-var">groupsPerPage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Cardano.Memory.Pool.html#ixBitSize"><span class="hs-identifier hs-var">ixBitSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">forall (n :: Nat). KnownNat n =&gt; Block n -&gt; Int
</span><a href="Cardano.Memory.Pool.html#blockByteCount"><span class="hs-identifier hs-var">blockByteCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Block n
</span><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-var">Block</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043181"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>        </span><span id="local-6989586621679042976"><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042976"><span class="hs-identifier hs-var">pageBitArray</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(PrimMonad m, Prim a) =&gt;
Int -&gt; m (MutablePrimArray (PrimState m) a)
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">newPrimArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679043008"><span class="hs-identifier hs-var">groupsPerPage</span></a></span><span>
</span><span id="line-133"></span><span>        </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(Prim a, PrimMonad m) =&gt;
MutablePrimArray (PrimState m) a -&gt; Int -&gt; Int -&gt; a -&gt; m ()
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">setPrimArray</span></a></span><span> </span><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042976"><span class="hs-identifier hs-var">pageBitArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679043008"><span class="hs-identifier hs-var">groupsPerPage</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-134"></span><span>        </span><span id="local-6989586621679042973"><span class="annot"><span class="annottext">PVar Int s
</span><a href="#local-6989586621679042973"><span class="hs-identifier hs-var">pageFull</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a.
(MonadPrim s m, Prim a) =&gt;
a -&gt; m (PVar a s)
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier hs-var">newPVar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-135"></span><span>        </span><span id="local-6989586621679042971"><span class="annot"><span class="annottext">MutVar s (Maybe (Page n s))
</span><a href="#local-6989586621679042971"><span class="hs-identifier hs-var">pageNextPage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
a -&gt; m (MutVar (PrimState m) a)
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">newMutVar</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ForeignPtr (Block n)
MutablePrimArray s Int
MutVar s (Maybe (Page n s))
PVar Int s
pageNextPage :: MutVar s (Maybe (Page n s))
pageFull :: PVar Int s
pageBitArray :: MutablePrimArray s Int
pageMemory :: ForeignPtr (Block n)
pageNextPage :: MutVar s (Maybe (Page n s))
pageFull :: PVar Int s
pageBitArray :: MutablePrimArray s Int
pageMemory :: ForeignPtr (Block n)
</span><a href="#local-6989586621679042971"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-137"></span><span>  </span><span id="local-6989586621679042969"><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042969"><span class="hs-identifier hs-var">firstPage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {n :: Nat}. ST s (Page n s)
</span><a href="#local-6989586621679042979"><span class="hs-identifier hs-var">pageInit</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-type">Pool</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">poolFirstPage :: Page n s
</span><a href="Cardano.Memory.Pool.html#poolFirstPage"><span class="hs-identifier hs-var">poolFirstPage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042969"><span class="hs-identifier hs-var">firstPage</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">poolPageInitializer :: ST s (Page n s)
</span><a href="Cardano.Memory.Pool.html#poolPageInitializer"><span class="hs-identifier hs-var">poolPageInitializer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {n :: Nat}. ST s (Page n s)
</span><a href="#local-6989586621679042979"><span class="hs-identifier hs-var">pageInit</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">poolBlockFinalizer :: Ptr (Block n) -&gt; IO ()
</span><a href="Cardano.Memory.Pool.html#poolBlockFinalizer"><span class="hs-identifier hs-var">poolBlockFinalizer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr (Block n) -&gt; IO ()
</span><a href="#local-6989586621679043006"><span class="hs-identifier hs-var">blockFinalizer</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | Reserve a `ForeignPtr` of the `blockByteCount` size in the `Pool`. There is a default</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- finalizer attached to the `ForeignPtr` that will run `Block` pointer finalizer and</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- release that memory for re-use by other blocks allocated in the future. It is safe to</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- add more Haskell finalizers with `addForeignPtrConcFinalizer` if necessary.</span><span>
</span><span id="line-149"></span><span id="local-6989586621679043147"><span id="local-6989586621679043148"><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextBlock"><span class="hs-identifier hs-type">grabNextBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-type">Pool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043148"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043147"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043147"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043148"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-150"></span><span id="grabNextBlock"><span class="annot"><span class="annottext">grabNextBlock :: forall (n :: Nat) s.
KnownNat n =&gt;
Pool n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="Cardano.Memory.Pool.html#grabNextBlock"><span class="hs-identifier hs-var hs-var">grabNextBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (n :: Nat) s.
(Page n s
 -&gt; (Ptr (Block n) -&gt; IO ()) -&gt; ST s (Maybe (ForeignPtr (Block n))))
-&gt; Pool n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="Cardano.Memory.Pool.html#grabNextPoolBlockWith"><span class="hs-identifier hs-var">grabNextPoolBlockWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (n :: Nat) s.
KnownNat n =&gt;
Page n s
-&gt; (Ptr (Block n) -&gt; IO ()) -&gt; ST s (Maybe (ForeignPtr (Block n)))
</span><a href="Cardano.Memory.Pool.html#grabNextPageForeignPtr"><span class="hs-identifier hs-var">grabNextPageForeignPtr</span></a></span><span>
</span><span id="line-151"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextBlock"><span class="hs-pragma hs-type">grabNextBlock</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | This is a helper function that will allocate a `Page` if the current `Page` in the</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- `Pool` is full. Whenever there are still block slots are available then supplied</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- @grabNext@ function will be used to reserve the slot in that `Page`.</span><span>
</span><span id="line-156"></span><span id="local-6989586621679043144"><span id="local-6989586621679043145"><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextPoolBlockWith"><span class="hs-identifier hs-type">grabNextPoolBlockWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043145"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043144"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043145"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043144"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043145"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#Pool"><span class="hs-identifier hs-type">Pool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043145"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043144"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043144"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043145"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-160"></span><span id="grabNextPoolBlockWith"><span class="annot"><span class="annottext">grabNextPoolBlockWith :: forall (n :: Nat) s.
(Page n s
 -&gt; (Ptr (Block n) -&gt; IO ()) -&gt; ST s (Maybe (ForeignPtr (Block n))))
-&gt; Pool n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="Cardano.Memory.Pool.html#grabNextPoolBlockWith"><span class="hs-identifier hs-var hs-var">grabNextPoolBlockWith</span></a></span></span><span> </span><span id="local-6989586621679042964"><span class="annot"><span class="annottext">Page n s
-&gt; (Ptr (Block n) -&gt; IO ()) -&gt; ST s (Maybe (ForeignPtr (Block n)))
</span><a href="#local-6989586621679042964"><span class="hs-identifier hs-var">grabNext</span></a></span></span><span> </span><span id="local-6989586621679042963"><span class="annot"><span class="annottext">Pool n s
</span><a href="#local-6989586621679042963"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Page n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="#local-6989586621679042962"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; Page n s
</span><a href="Cardano.Memory.Pool.html#poolFirstPage"><span class="hs-identifier hs-var">poolFirstPage</span></a></span><span> </span><span class="annot"><span class="annottext">Pool n s
</span><a href="#local-6989586621679042963"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621679042962"><span class="annot"><span class="annottext">go :: Page n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="#local-6989586621679042962"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679042946"><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042946"><span class="hs-identifier hs-var">page</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>      </span><span id="local-6989586621679042945"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042945"><span class="hs-identifier hs-var">isPageFull</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadPrim s m =&gt; PVar Int s -&gt; m Int
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier hs-var">atomicReadIntPVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; PVar Int s
</span><a href="Cardano.Memory.Pool.html#pageFull"><span class="hs-identifier hs-var">pageFull</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042946"><span class="hs-identifier hs-var">page</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Cardano.Memory.Pool.html#intToBool"><span class="hs-identifier hs-var">intToBool</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042945"><span class="hs-identifier hs-var">isPageFull</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MutVar (PrimState m) a -&gt; m a
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">readMutVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; MutVar s (Maybe (Page n s))
</span><a href="Cardano.Memory.Pool.html#pageNextPage"><span class="hs-identifier hs-var">pageNextPage</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042946"><span class="hs-identifier hs-var">page</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-167"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>              </span><span id="local-6989586621679042942"><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042942"><span class="hs-identifier hs-var">newPage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; ST s (Page n s)
</span><a href="Cardano.Memory.Pool.html#poolPageInitializer"><span class="hs-identifier hs-var">poolPageInitializer</span></a></span><span> </span><span class="annot"><span class="annottext">Pool n s
</span><a href="#local-6989586621679042963"><span class="hs-identifier hs-var">pool</span></a></span><span>
</span><span id="line-169"></span><span>              </span><span class="hs-comment">-- There is a slight chance of a race condition in that the next page could</span><span>
</span><span id="line-170"></span><span>              </span><span class="hs-comment">-- have been allocated and assigned to 'pageNextPage' by another thread</span><span>
</span><span id="line-171"></span><span>              </span><span class="hs-comment">-- since we last checked for it. This is not a problem since we can safely</span><span>
</span><span id="line-172"></span><span>              </span><span class="hs-comment">-- discard the page created in this thread and switch to the one that was</span><span>
</span><span id="line-173"></span><span>              </span><span class="hs-comment">-- assigned to 'pageNextPage'.</span><span>
</span><span id="line-174"></span><span>              </span><span id="local-6989586621679042941"><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="#local-6989586621679042941"><span class="hs-identifier hs-var">mNextPage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-175"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
PrimMonad m =&gt;
MutVar (PrimState m) a -&gt; (a -&gt; (a, b)) -&gt; m b
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">atomicModifyMutVar'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; MutVar s (Maybe (Page n s))
</span><a href="Cardano.Memory.Pool.html#pageNextPage"><span class="hs-identifier hs-var">pageNextPage</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042946"><span class="hs-identifier hs-var">page</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679042939"><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="#local-6989586621679042939"><span class="hs-identifier hs-var">mNextPage</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="#local-6989586621679042939"><span class="hs-identifier hs-var">mNextPage</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042942"><span class="hs-identifier hs-var">newPage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="#local-6989586621679042939"><span class="hs-identifier hs-var">mNextPage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="#local-6989586621679042941"><span class="hs-identifier hs-var">mNextPage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Page n s)
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Page n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="#local-6989586621679042962"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042942"><span class="hs-identifier hs-var">newPage</span></a></span><span>
</span><span id="line-179"></span><span>                </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679042937"><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042937"><span class="hs-identifier hs-var">existingPage</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>                  </span><span class="hs-comment">-- Here we cleanup the newly allocated page in favor of the one that</span><span>
</span><span id="line-181"></span><span>                  </span><span class="hs-comment">-- was potentially created by another thread. It is important to</span><span>
</span><span id="line-182"></span><span>                  </span><span class="hs-comment">-- eagerly free up scarce resources.</span><span>
</span><span id="line-183"></span><span>                  </span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span>                  </span><span class="hs-comment">-- This operation is idempotent and thread safe</span><span>
</span><span id="line-185"></span><span>                  </span><span class="annot"><span class="annottext">forall a s. IO a -&gt; ST s a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unsafeIOToST</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ForeignPtr a -&gt; IO ()
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">finalizeForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Page n s -&gt; ForeignPtr (Block n)
</span><a href="Cardano.Memory.Pool.html#pageMemory"><span class="hs-identifier hs-var">pageMemory</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042942"><span class="hs-identifier hs-var">newPage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>                  </span><span class="annot"><span class="annottext">Page n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="#local-6989586621679042962"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042937"><span class="hs-identifier hs-var">existingPage</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679042934"><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042934"><span class="hs-identifier hs-var">nextPage</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Page n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="#local-6989586621679042962"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042934"><span class="hs-identifier hs-var">nextPage</span></a></span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><span class="annottext">Page n s
-&gt; (Ptr (Block n) -&gt; IO ()) -&gt; ST s (Maybe (ForeignPtr (Block n)))
</span><a href="#local-6989586621679042964"><span class="hs-identifier hs-var">grabNext</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042946"><span class="hs-identifier hs-var">page</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat) s. Pool n s -&gt; Ptr (Block n) -&gt; IO ()
</span><a href="Cardano.Memory.Pool.html#poolBlockFinalizer"><span class="hs-identifier hs-var">poolBlockFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">Pool n s
</span><a href="#local-6989586621679042963"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-190"></span><span>            </span><span class="annot"><span class="annottext">Maybe (ForeignPtr (Block n))
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Page n s -&gt; ST s (ForeignPtr (Block n))
</span><a href="#local-6989586621679042962"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042946"><span class="hs-identifier hs-var">page</span></a></span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679042933"><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042933"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042933"><span class="hs-identifier hs-var">ma</span></a></span><span>
</span><span id="line-192"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextPoolBlockWith"><span class="hs-pragma hs-type">grabNextPoolBlockWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="annot"><a href="Cardano.Memory.Pool.html#intToBool"><span class="hs-identifier hs-type">intToBool</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-195"></span><span id="intToBool"><span class="annot"><span class="annottext">intToBool :: Int -&gt; Bool
</span><a href="Cardano.Memory.Pool.html#intToBool"><span class="hs-identifier hs-var hs-var">intToBool</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-196"></span><span class="annot"><a href="Cardano.Memory.Pool.html#intToBool"><span class="hs-identifier hs-var">intToBool</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | This is a helper function that will attempt to find the next available slot for the</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- `Block` and create a `ForeignPtr` with the size of `Block` in the `Page`. In case when</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- `Page` is full it will return `Nothing`.</span><span>
</span><span id="line-201"></span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextPageForeignPtr"><span class="hs-identifier hs-type">grabNextPageForeignPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043143"><span class="annot"><a href="#local-6989586621679043143"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679043142"><span class="annot"><a href="#local-6989586621679043142"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043143"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-comment">-- | Page to grab the block from</span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043143"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043142"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-comment">-- | Finalizer to run, once the `ForeignPtr` holding on to `Ptr` `Block` is no longer used</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043143"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043142"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043143"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span id="grabNextPageForeignPtr"><span class="annot"><span class="annottext">grabNextPageForeignPtr :: forall (n :: Nat) s.
KnownNat n =&gt;
Page n s
-&gt; (Ptr (Block n) -&gt; IO ()) -&gt; ST s (Maybe (ForeignPtr (Block n)))
</span><a href="Cardano.Memory.Pool.html#grabNextPageForeignPtr"><span class="hs-identifier hs-var hs-var">grabNextPageForeignPtr</span></a></span></span><span> </span><span id="local-6989586621679042924"><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042924"><span class="hs-identifier hs-var">page</span></a></span></span><span> </span><span id="local-6989586621679042923"><span class="annot"><span class="annottext">Ptr (Block n) -&gt; IO ()
</span><a href="#local-6989586621679042923"><span class="hs-identifier hs-var">finalizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">forall (n :: Nat) s.
KnownNat n =&gt;
Page n s
-&gt; (Ptr (Block n) -&gt; IO () -&gt; IO (ForeignPtr (Block n)))
-&gt; ST s (Maybe (ForeignPtr (Block n)))
</span><a href="Cardano.Memory.Pool.html#grabNextPageWithAllocator"><span class="hs-identifier hs-var">grabNextPageWithAllocator</span></a></span><span> </span><span class="annot"><span class="annottext">Page n s
</span><a href="#local-6989586621679042924"><span class="hs-identifier hs-var">page</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679042921"><span class="annot"><span class="annottext">Ptr (Block n)
</span><a href="#local-6989586621679042921"><span class="hs-identifier hs-var">blockPtr</span></a></span></span><span> </span><span id="local-6989586621679042920"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679042920"><span class="hs-identifier hs-var">resetIndex</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621679042919"><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042919"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Ptr a -&gt; IO (ForeignPtr a)
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">newForeignPtr_</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr (Block n)
</span><a href="#local-6989586621679042921"><span class="hs-identifier hs-var">blockPtr</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">forall a. ForeignPtr a -&gt; IO () -&gt; IO ()
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">addForeignPtrConcFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042919"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr (Block n) -&gt; IO ()
</span><a href="#local-6989586621679042923"><span class="hs-identifier hs-var">finalizer</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr (Block n)
</span><a href="#local-6989586621679042921"><span class="hs-identifier hs-var">blockPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679042920"><span class="hs-identifier hs-var">resetIndex</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042919"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-214"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextPageForeignPtr"><span class="hs-pragma hs-type">grabNextPageForeignPtr</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextPageWithAllocator"><span class="hs-identifier hs-type">grabNextPageWithAllocator</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043126"><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span id="local-6989586621679043125"><span class="annot"><a href="#local-6989586621679043125"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043125"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043125"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ForeignPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span id="grabNextPageWithAllocator"><span class="annot"><span class="annottext">grabNextPageWithAllocator :: forall (n :: Nat) s.
KnownNat n =&gt;
Page n s
-&gt; (Ptr (Block n) -&gt; IO () -&gt; IO (ForeignPtr (Block n)))
-&gt; ST s (Maybe (ForeignPtr (Block n)))
</span><a href="Cardano.Memory.Pool.html#grabNextPageWithAllocator"><span class="hs-identifier hs-var hs-var">grabNextPageWithAllocator</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Page"><span class="hs-identifier hs-type">Page</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679042899"><span id="local-6989586621679042900"><span id="local-6989586621679042901"><span id="local-6989586621679042902"><span class="annot"><span class="annottext">ForeignPtr (Block n)
MutablePrimArray s Int
MutVar s (Maybe (Page n s))
PVar Int s
pageNextPage :: MutVar s (Maybe (Page n s))
pageFull :: PVar Int s
pageBitArray :: MutablePrimArray s Int
pageMemory :: ForeignPtr (Block n)
pageNextPage :: forall (n :: Nat) s. Page n s -&gt; MutVar s (Maybe (Page n s))
pageFull :: forall (n :: Nat) s. Page n s -&gt; PVar Int s
pageBitArray :: forall (n :: Nat) s. Page n s -&gt; MutablePrimArray s Int
pageMemory :: forall (n :: Nat) s. Page n s -&gt; ForeignPtr (Block n)
</span><a href="#local-6989586621679042899"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679042898"><span class="annot"><span class="annottext">Ptr (Block n) -&gt; IO () -&gt; IO (ForeignPtr (Block n))
</span><a href="#local-6989586621679042898"><span class="hs-identifier hs-var">allocator</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="annottext">forall s. MutablePrimArray s Int -&gt; ST s (Maybe Int)
</span><a href="Cardano.Memory.Pool.html#setNextZero"><span class="hs-identifier hs-var">setNextZero</span></a></span><span> </span><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042901"><span class="hs-identifier hs-var">pageBitArray</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-comment">-- There is a slight chance that some Blocks will be cleared before the pageFull is</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-comment">-- set to True. This is not a problem because that memory will be recovered as soon as</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- any other Block in the Page is finalized</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- TODO: Potentially verify that first Int in pageBitArray has all bits set, in</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- order to prevent the degenerate case of all Blocks beeing finalized right before</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- the page is marked as full.</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadPrim s m =&gt; PVar Int s -&gt; Int -&gt; m ()
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier hs-var">atomicWriteIntPVar</span></a></span><span> </span><span class="annot"><span class="annottext">PVar Int s
</span><a href="#local-6989586621679042900"><span class="hs-identifier hs-var">pageFull</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679042894"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042894"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">forall a s. IO a -&gt; ST s a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unsafeIOToST</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-235"></span><span>          </span><span class="annot"><span class="annottext">forall a b. ForeignPtr a -&gt; (Ptr a -&gt; IO b) -&gt; IO b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">withForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042902"><span class="hs-identifier hs-var">pageMemory</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679042892"><span class="annot"><span class="annottext">Ptr (Block n)
</span><a href="#local-6989586621679042892"><span class="hs-identifier hs-var">pagePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679042889"><span class="annot"><span class="annottext">blockPtr :: Ptr b
</span><a href="#local-6989586621679042889"><span class="hs-identifier hs-var hs-var">blockPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>                  </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr (Block n)
</span><a href="#local-6989586621679042892"><span class="hs-identifier hs-var">pagePtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042894"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">forall (n :: Nat). KnownNat n =&gt; Block n -&gt; Int
</span><a href="Cardano.Memory.Pool.html#blockByteCount"><span class="hs-identifier hs-var">blockByteCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Block n
</span><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-var">Block</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Ptr (Block n) -&gt; IO () -&gt; IO (ForeignPtr (Block n))
</span><a href="#local-6989586621679042898"><span class="hs-identifier hs-var">allocator</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679042889"><span class="hs-identifier hs-var">blockPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679042885"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042885"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679042884"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042884"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042894"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Cardano.Memory.Pool.html#ixBitSize"><span class="hs-identifier hs-var">ixBitSize</span></a></span><span>
</span><span id="line-240"></span><span>                      </span><span class="hs-glyph">!</span><span id="local-6989586621679042878"><span class="annot"><span class="annottext">pageBitMask :: Int
</span><a href="#local-6989586621679042878"><span class="hs-identifier hs-var hs-var">pageBitMask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">clearBit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Bits a =&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">complement</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042884"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-241"></span><span>                  </span><span class="annot"><span class="annottext">forall a. ForeignPtr a -&gt; IO ()
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">touchForeignPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtr (Block n)
</span><a href="#local-6989586621679042902"><span class="hs-identifier hs-var">pageMemory</span></a></span><span>
</span><span id="line-242"></span><span>                  </span><span class="annot"><span class="annottext">forall s a. ST s a -&gt; IO a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unsafeSTToIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall s. MutablePrimArray s Int -&gt; Int -&gt; Int -&gt; ST s ()
</span><a href="Cardano.Memory.Pool.html#atomicAndIntMutablePrimArray"><span class="hs-identifier hs-var">atomicAndIntMutablePrimArray</span></a></span><span> </span><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042901"><span class="hs-identifier hs-var">pageBitArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042885"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042878"><span class="hs-identifier hs-var">pageBitMask</span></a></span><span>
</span><span id="line-243"></span><span>                  </span><span class="annot"><span class="annottext">forall s a. ST s a -&gt; IO a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">unsafeSTToIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadPrim s m =&gt; PVar Int s -&gt; Int -&gt; m ()
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier hs-var">atomicWriteIntPVar</span></a></span><span> </span><span class="annot"><span class="annottext">PVar Int s
</span><a href="#local-6989586621679042900"><span class="hs-identifier hs-var">pageFull</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-244"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#grabNextPageWithAllocator"><span class="hs-pragma hs-type">grabNextPageWithAllocator</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="hs-comment">-- | Atomically AND an element of the array</span><span>
</span><span id="line-247"></span><span id="local-6989586621679043099"><span class="annot"><a href="Cardano.Memory.Pool.html#atomicAndIntMutablePrimArray"><span class="hs-identifier hs-type">atomicAndIntMutablePrimArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043099"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043099"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-248"></span><span id="atomicAndIntMutablePrimArray"><span class="annot"><span class="annottext">atomicAndIntMutablePrimArray :: forall s. MutablePrimArray s Int -&gt; Int -&gt; Int -&gt; ST s ()
</span><a href="Cardano.Memory.Pool.html#atomicAndIntMutablePrimArray"><span class="hs-identifier hs-var hs-var">atomicAndIntMutablePrimArray</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span id="local-6989586621679042871"><span class="annot"><span class="annottext">MutableByteArray# s
</span><a href="#local-6989586621679042871"><span class="hs-identifier hs-var">mba#</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679042870"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042870"><span class="hs-identifier hs-var">i#</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679042869"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042869"><span class="hs-identifier hs-var">m#</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><span class="annottext">forall s a. STRep s a -&gt; ST s a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">ST</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679042867"><span class="annot"><span class="annottext">State# s
</span><a href="#local-6989586621679042867"><span class="hs-identifier hs-var">s#</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall d.
MutableByteArray# d
-&gt; Int# -&gt; Int# -&gt; State# d -&gt; (# State# d, Int# #)
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">fetchAndIntArray#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# s
</span><a href="#local-6989586621679042871"><span class="hs-identifier hs-var">mba#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042870"><span class="hs-identifier hs-var">i#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042869"><span class="hs-identifier hs-var">m#</span></a></span><span> </span><span class="annot"><span class="annottext">State# s
</span><a href="#local-6989586621679042867"><span class="hs-identifier hs-var">s#</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679042866"><span class="annot"><span class="annottext">State# s
</span><a href="#local-6989586621679042866"><span class="hs-identifier hs-var">s'#</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int#
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# s
</span><a href="#local-6989586621679042866"><span class="hs-identifier hs-var">s'#</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-252"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#atomicAndIntMutablePrimArray"><span class="hs-pragma hs-type">atomicAndIntMutablePrimArray</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- | Atomically modify an element of the array</span><span>
</span><span id="line-255"></span><span id="local-6989586621679043092"><span id="local-6989586621679043093"><span class="annot"><a href="Cardano.Memory.Pool.html#atomicModifyMutablePrimArray"><span class="hs-identifier hs-type">atomicModifyMutablePrimArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043093"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679043092"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043093"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043092"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-256"></span><span id="atomicModifyMutablePrimArray"><span class="annot"><span class="annottext">atomicModifyMutablePrimArray :: forall s a.
MutablePrimArray s Int -&gt; Int -&gt; (Int -&gt; (Int, a)) -&gt; ST s a
</span><a href="Cardano.Memory.Pool.html#atomicModifyMutablePrimArray"><span class="hs-identifier hs-var hs-var">atomicModifyMutablePrimArray</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span id="local-6989586621679042864"><span class="annot"><span class="annottext">MutableByteArray# s
</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">mba#</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679042863"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">i#</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679042862"><span class="annot"><span class="annottext">Int -&gt; (Int, a)
</span><a href="#local-6989586621679042862"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">forall s a. STRep s a -&gt; ST s a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">ST</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall d b.
MutableByteArray# d
-&gt; Int# -&gt; (Int# -&gt; (# Int#, b #)) -&gt; State# d -&gt; (# State# d, b #)
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/pvar-1.0.0.0-d76c005c718755dd383158507a96eee5fcae016032b759d1f0caa999985f6e38/share/doc/html/src"><span class="hs-identifier hs-var">atomicModifyIntArray#</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# s
</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">mba#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">i#</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679042861"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042861"><span class="hs-identifier hs-var">x#</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (Int, a)
</span><a href="#local-6989586621679042862"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int# -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">I#</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042861"><span class="hs-identifier hs-var">x#</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">I#</span></a></span><span> </span><span id="local-6989586621679042860"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042860"><span class="hs-identifier hs-var">y#</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679042859"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042859"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679042860"><span class="hs-identifier hs-var">y#</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042859"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">#)</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#atomicModifyMutablePrimArray"><span class="hs-pragma hs-type">atomicModifyMutablePrimArray</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-comment">-- | Helper function that finds an index of the left-most bit that is not set.</span><span>
</span><span id="line-261"></span><span class="annot"><a href="Cardano.Memory.Pool.html#findNextZeroIndex"><span class="hs-identifier hs-type">findNextZeroIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043087"><span class="annot"><a href="#local-6989586621679043087"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">FiniteBits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043087"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679043087"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-262"></span><span id="findNextZeroIndex"><span class="annot"><span class="annottext">findNextZeroIndex :: forall b. FiniteBits b =&gt; b -&gt; Maybe Int
</span><a href="Cardano.Memory.Pool.html#findNextZeroIndex"><span class="hs-identifier hs-var hs-var">findNextZeroIndex</span></a></span></span><span> </span><span id="local-6989586621679042850"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679042850"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679042848"><span class="annot"><span class="annottext">i0 :: Int
</span><a href="#local-6989586621679042848"><span class="hs-identifier hs-var hs-var">i0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. FiniteBits b =&gt; b -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">countTrailingZeros</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679042850"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span id="local-6989586621679042844"><span class="annot"><span class="annottext">i1 :: Int
</span><a href="#local-6989586621679042844"><span class="hs-identifier hs-var hs-var">i1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. FiniteBits b =&gt; b -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">countTrailingZeros</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Bits a =&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">complement</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679042850"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>      </span><span id="local-6989586621679042840"><span class="annot"><span class="annottext">maxBits :: Int
</span><a href="#local-6989586621679042840"><span class="hs-identifier hs-var hs-var">maxBits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. FiniteBits b =&gt; b -&gt; Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">finiteBitSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679043087"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042848"><span class="hs-identifier hs-var">i0</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-268"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042844"><span class="hs-identifier hs-var">i1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042840"><span class="hs-identifier hs-var">maxBits</span></a></span><span>
</span><span id="line-269"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-270"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042844"><span class="hs-identifier hs-var">i1</span></a></span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042848"><span class="hs-identifier hs-var">i0</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#findNextZeroIndex"><span class="hs-pragma hs-type">findNextZeroIndex</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span class="hs-comment">-- | Finds an index of the next bit that is not set in the bit array and flips it</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- atomically. In case when all bits are set, then `Nothing` is returned. It is possible</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- that while search is ongoing bits that where checked get cleared. This is totally fine</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- for our implementation of mempool.</span><span>
</span><span id="line-278"></span><span id="local-6989586621679043117"><span class="annot"><a href="Cardano.Memory.Pool.html#setNextZero"><span class="hs-identifier hs-type">setNextZero</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043117"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043117"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-279"></span><span id="setNextZero"><span class="annot"><span class="annottext">setNextZero :: forall s. MutablePrimArray s Int -&gt; ST s (Maybe Int)
</span><a href="Cardano.Memory.Pool.html#setNextZero"><span class="hs-identifier hs-var hs-var">setNextZero</span></a></span></span><span> </span><span id="local-6989586621679042836"><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042836"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s a.
MutablePrimArray s Int
-&gt; (Int -&gt; Int -&gt; (Int, Maybe a)) -&gt; ST s (Maybe a)
</span><a href="Cardano.Memory.Pool.html#ifindAtomicMutablePrimArray"><span class="hs-identifier hs-var">ifindAtomicMutablePrimArray</span></a></span><span> </span><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042836"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. FiniteBits a =&gt; Int -&gt; a -&gt; (a, Maybe Int)
</span><a href="#local-6989586621679042834"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621679042834"><span class="annot"><span class="annottext">f :: Int -&gt; a -&gt; (a, Maybe Int)
</span><a href="#local-6989586621679042834"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679042827"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042827"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679042826"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042826"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall b. FiniteBits b =&gt; b -&gt; Maybe Int
</span><a href="Cardano.Memory.Pool.html#findNextZeroIndex"><span class="hs-identifier hs-var">findNextZeroIndex</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042826"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042826"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>        </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679042825"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042825"><span class="hs-identifier hs-var">bitIx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">setBit</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042826"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042825"><span class="hs-identifier hs-var">bitIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Cardano.Memory.Pool.html#ixBitSize"><span class="hs-identifier hs-var">ixBitSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042827"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042825"><span class="hs-identifier hs-var">bitIx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#setNextZero"><span class="hs-pragma hs-type">setNextZero</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span id="local-6989586621679043080"><span id="local-6989586621679043081"><span class="annot"><a href="Cardano.Memory.Pool.html#ifindAtomicMutablePrimArray"><span class="hs-identifier hs-type">ifindAtomicMutablePrimArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-288"></span><span>  </span><span class="annot"><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-type">MutablePrimArray</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043081"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043080"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043081"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043080"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-291"></span><span id="ifindAtomicMutablePrimArray"><span class="annot"><span class="annottext">ifindAtomicMutablePrimArray :: forall s a.
MutablePrimArray s Int
-&gt; (Int -&gt; Int -&gt; (Int, Maybe a)) -&gt; ST s (Maybe a)
</span><a href="Cardano.Memory.Pool.html#ifindAtomicMutablePrimArray"><span class="hs-identifier hs-var hs-var">ifindAtomicMutablePrimArray</span></a></span></span><span> </span><span id="local-6989586621679042820"><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042820"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span id="local-6989586621679042819"><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Maybe a)
</span><a href="#local-6989586621679042819"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621679042818"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042818"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(PrimMonad m, Prim a) =&gt;
MutablePrimArray (PrimState m) a -&gt; m Int
</span><a href="../file:///home/runner/.local/state/cabal/store/ghc-9.2.8/primitive-0.9.0.0-3330279c452f71c5f5b716fdb5b8bee5dd18895b312d46aed41809ce58820ec7/share/doc/html/src"><span class="hs-identifier hs-var">getSizeofMutablePrimArray</span></a></span><span> </span><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042820"><span class="hs-identifier hs-var">ma</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679042810"><span class="annot"><span class="annottext">go :: Int -&gt; ST s (Maybe a)
</span><a href="#local-6989586621679042810"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679042809"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042809"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042809"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042818"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">forall s a.
MutablePrimArray s Int -&gt; Int -&gt; (Int -&gt; (Int, a)) -&gt; ST s a
</span><a href="Cardano.Memory.Pool.html#atomicModifyMutablePrimArray"><span class="hs-identifier hs-var">atomicModifyMutablePrimArray</span></a></span><span> </span><span class="annot"><span class="annottext">MutablePrimArray s Int
</span><a href="#local-6989586621679042820"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042809"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Maybe a)
</span><a href="#local-6989586621679042819"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042809"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-297"></span><span>              </span><span class="annot"><span class="annottext">Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (Maybe a)
</span><a href="#local-6989586621679042810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679042809"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>              </span><span class="annot"><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679042808"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042808"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../file:///usr/local/.ghcup/ghc/9.2.8/share/doc/ghc-9.2.8/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679042808"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; ST s (Maybe a)
</span><a href="#local-6989586621679042810"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-300"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Cardano.Memory.Pool.html#ifindAtomicMutablePrimArray"><span class="hs-pragma hs-type">ifindAtomicMutablePrimArray</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-301"></span></pre></body></html>